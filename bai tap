import tkinter as tk
from tkinter import ttk, messagebox
import csv
import pandas as pd
from datetime import datetime

# File CSV để lưu trữ dữ liệu
FILE_NAME = "nhanvien.csv"

def save_to_csv():
    """Lưu thông tin nhân viên vào file CSV"""
    data = [
        entry_id.get(),
        entry_name.get(),
        entry_dob.get(),
        gender.get(),
        entry_idnum.get(),
        entry_issuedate.get(),
        entry_department.get(),
        entry_position.get()
    ]
    if "" in data:
        messagebox.showwarning("Lỗi", "Vui lòng nhập đầy đủ thông tin!")
    else:
        with open(FILE_NAME, mode="a", newline="", encoding="utf-8") as file:
            writer = csv.writer(file)
            writer.writerow(data)
        messagebox.showinfo("Thành công", "Dữ liệu đã được lưu!")
        clear_entries()

def load_birthdays_today():
    """Hiển thị nhân viên có sinh nhật hôm nay"""
    try:
        today = datetime.now().strftime("%d/%m")
        with open(FILE_NAME, mode="r", encoding="utf-8") as file:
            reader = csv.reader(file)
            birthdays = [row for row in reader if row[2][:5] == today]
        if birthdays:
            result = "\n".join([f"Mã: {row[0]}, Tên: {row[1]}" for row in birthdays])
            messagebox.showinfo("Sinh nhật hôm nay", result)
        else:
            messagebox.showinfo("Sinh nhật hôm nay", "Không có nhân viên nào sinh nhật hôm nay.")
    except FileNotFoundError:
        messagebox.showerror("Lỗi", "Chưa có dữ liệu nhân viên!")

def export_to_excel():
    """Xuất toàn bộ danh sách nhân viên ra file Excel và sắp xếp theo tuổi giảm dần"""
    try:
        df = pd.read_csv(FILE_NAME, names=["Mã", "Tên", "Ngày sinh", "Giới tính", "Số CMND",
                                          "Ngày cấp", "Đơn vị", "Chức danh"])
        df["Tuổi"] = pd.to_datetime(df["Ngày sinh"], dayfirst=True).apply(
            lambda x: datetime.now().year - x.year if pd.notnull(x) else 0
        )
        df_sorted = df.sort_values(by="Tuổi", ascending=False)
        df_sorted.to_excel("danhsach_nhanvien.xlsx", index=False)
        messagebox.showinfo("Thành công", "Dữ liệu đã được xuất ra file Excel: danhsach_nhanvien.xlsx")
    except FileNotFoundError:
        messagebox.showerror("Lỗi", "Chưa có dữ liệu nhân viên!")

def clear_entries():
    """Xóa các trường nhập liệu"""
    entry_id.delete(0, tk.END)
    entry_name.delete(0, tk.END)
    entry_dob.delete(0, tk.END)
    entry_idnum.delete(0, tk.END)
    entry_issuedate.delete(0, tk.END)
    entry_department.set("")
    entry_position.delete(0, tk.END)

# Tạo cửa sổ chính
root = tk.Tk()
root.title("Quản lý thông tin nhân viên")
root.geometry("500x600")

# Các trường nhập liệu
tk.Label(root, text="Mã nhân viên").pack()
entry_id = tk.Entry(root)
entry_id.pack()

tk.Label(root, text="Tên nhân viên").pack()
entry_name = tk.Entry(root)
entry_name.pack()

tk.Label(root, text="Ngày sinh (dd/mm/yyyy)").pack()
entry_dob = tk.Entry(root)
entry_dob.pack()

tk.Label(root, text="Giới tính").pack()
gender = tk.StringVar(value="Nam")
tk.Radiobutton(root, text="Nam", variable=gender, value="Nam").pack()
tk.Radiobutton(root, text="Nữ", variable=gender, value="Nữ").pack()

tk.Label(root, text="Số CMND").pack()
entry_idnum = tk.Entry(root)
entry_idnum.pack()

tk.Label(root, text="Ngày cấp (dd/mm/yyyy)").pack()
entry_issuedate = tk.Entry(root)
entry_issuedate.pack()

tk.Label(root, text="Đơn vị").pack()
entry_department = ttk.Combobox(root, values=["Phòng kế toán", "Phòng kỹ thuật", "Phân xưởng que hàn"])
entry_department.pack()

tk.Label(root, text="Chức danh").pack()
entry_position = tk.Entry(root)
entry_position.pack()

# Các nút chức năng
btn_save = tk.Button(root, text="Lưu thông tin", command=save_to_csv)
btn_save.pack(pady=5)

btn_birthdays = tk.Button(root, text="Sinh nhật hôm nay", command=load_birthdays_today)
btn_birthdays.pack(pady=5)

btn_export = tk.Button(root, text="Xuất danh sách Excel", command=export_to_excel)
btn_export.pack(pady=5)

# Khởi chạy chương trình
root.mainloop()
